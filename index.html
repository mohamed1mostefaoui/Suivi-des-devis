<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actemium - Tableau de Bord Gestion (Complet & Optimisé)</title>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Utilitaires -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- CONFIGURATION TAILWIND -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        actemium: {
                            primary: '#002e60',  
                            secondary: '#004289', 
                            accent: '#C6D200',    
                            orange: '#D3641A',    
                            text: '#334155',      
                            light: '#f1f5f9'      
                        }
                    },
                    fontFamily: {
                        sans: ['"Source Sans Pro"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'hover': '0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04)',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        th { cursor: pointer; user-select: none; }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .glass-header { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONSTANTES & UTILITAIRES ---
        const { useState, useMemo, useRef, useEffect, useCallback, useTransition, memo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        const COLORS = { primary: '#002e60', secondary: '#004289', accent: '#C6D200', orange: '#D3641A', success: '#059669', danger: '#dc2626', grid: '#e2e8f0' };

        const formatCurrency = (value, decimals = 0) => {
            if (value === undefined || value === null) return '-';
            return value.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: decimals });
        };

        // --- HOOKS OPTIMISÉS ---
        const useSortableData = (items, config = null) => {
            const [sortConfig, setSortConfig] = useState(config);
            const [isPending, startTransition] = useTransition();

            const sortedItems = useMemo(() => {
                let sortableItems = [...items];
                if (sortConfig !== null) {
                    sortableItems.sort((a, b) => {
                        let aVal = a[sortConfig.key];
                        let bVal = b[sortConfig.key];
                        if (typeof aVal === 'string') {
                            aVal = aVal.toLowerCase();
                            bVal = bVal.toLowerCase();
                        }
                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return sortableItems;
            }, [items, sortConfig]);

            const requestSort = useCallback((key) => {
                startTransition(() => {
                    setSortConfig(current => {
                        let direction = 'asc';
                        if (current && current.key === key && current.direction === 'asc') {
                            direction = 'desc';
                        }
                        return { key, direction };
                    });
                });
            }, []);

            return { items: sortedItems, requestSort, sortConfig, isPending };
        };

        const usePagination = (data, itemsPerPage = 15) => {
            const [currentPage, setCurrentPage] = useState(1);
            useEffect(() => { setCurrentPage(1); }, [data.length]);
            const maxPage = Math.ceil(data.length / itemsPerPage);
            const currentData = useMemo(() => {
                const begin = (currentPage - 1) * itemsPerPage;
                const end = begin + itemsPerPage;
                return data.slice(begin, end);
            }, [data, currentPage, itemsPerPage]);
            const next = () => setCurrentPage(c => Math.min(c + 1, maxPage));
            const prev = () => setCurrentPage(c => Math.max(c - 1, 1));
            return { next, prev, currentData, currentPage, maxPage };
        };

        // --- COMPOSANTS UI BASE (MEMOIZED) ---
        const Icon = memo(({ children, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        
        const Icons = {
            LayoutDashboard: (p) => <Icon {...p}><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></Icon>,
            Wallet: (p) => <Icon {...p}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></Icon>,
            TrendingUp: (p) => <Icon {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></Icon>,
            AlertCircle: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></Icon>,
            AlertTriangle: (p) => <Icon {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>,
            Clock: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>,
            Hourglass: (p) => <Icon {...p}><path d="M4.5 3h15"/><path d="M4.5 21h15"/><path d="M6 3v6a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"/><path d="M6 21v-6a6 6 0 0 1 6-6 6 6 0 0 1 6 6v6"/></Icon>,
            BarChart2: (p) => <Icon {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></Icon>,
            Upload: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></Icon>,
            ChevronUp: (p) => <Icon {...p}><path d="m18 15-6-6-6 6"/></Icon>,
            ChevronDown: (p) => <Icon {...p}><path d="m6 9 6 6 6-6"/></Icon>,
            ChevronLeft: (p) => <Icon {...p}><polyline points="15 18 9 12 15 6"></polyline></Icon>,
            ChevronRight: (p) => <Icon {...p}><polyline points="9 18 15 12 9 6"></polyline></Icon>,
            Factory: (p) => <Icon {...p}><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><line x1="17" x2="17" y1="18" y2="18"/><line x1="12" x2="12" y1="18" y2="18"/><line x1="7" x2="7" y1="18" y2="18"/></Icon>,
            Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12" /></Icon>,
            Filter: (p) => <Icon {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></Icon>,
            Menu: (p) => <Icon {...p}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></Icon>,
            X: (p) => <Icon {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>,
            Search: (p) => <Icon {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></Icon>,
            Trash: (p) => <Icon {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></Icon>,
            Activity: (p) => <Icon {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></Icon>,
            RefreshCw: (p) => <Icon {...p}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></Icon>,
            FileText: (p) => <Icon {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></Icon>,
            PieChart: (p) => <Icon {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></Icon>,
            Package: (p) => <Icon {...p}><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></Icon>,
            ShoppingCart: (p) => <Icon {...p}><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></Icon>,
            Target: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></Icon>
        };

        const Card = memo(({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-soft border border-slate-100 p-6 ${className}`}>{children}</div>
        ));

        const PaginationControls = memo(({ currentPage, maxPage, next, prev }) => {
            if (maxPage <= 1) return null;
            return (
                <div className="flex items-center justify-between px-6 py-4 border-t border-slate-100 bg-white">
                    <span className="text-sm text-slate-500">Page {currentPage} sur {maxPage}</span>
                    <div className="flex items-center gap-2">
                        <button onClick={prev} disabled={currentPage === 1} className="p-2 rounded hover:bg-slate-100 disabled:opacity-30 disabled:hover:bg-transparent"><Icons.ChevronLeft className="w-4 h-4"/></button>
                        <button onClick={next} disabled={currentPage === maxPage} className="p-2 rounded hover:bg-slate-100 disabled:opacity-30 disabled:hover:bg-transparent"><Icons.ChevronRight className="w-4 h-4"/></button>
                    </div>
                </div>
            );
        });

        const KPICard = memo(({ title, value, subtext, icon, type = "blue" }) => {
            const themes = {
                blue:   { text: "text-actemium-secondary", iconBg: "bg-blue-50 text-actemium-secondary" },
                orange: { text: "text-actemium-orange",    iconBg: "bg-orange-50 text-actemium-orange" },
                green:  { text: "text-emerald-600",        iconBg: "bg-emerald-50 text-emerald-600" }, 
                red:    { text: "text-red-600",            iconBg: "bg-red-50 text-red-600" }
            };
            const t = themes[type] || themes.blue;
            return (
                <div className="rounded-xl border border-slate-100 p-6 bg-white shadow-soft flex items-start justify-between transition-all duration-300 hover:shadow-hover hover:-translate-y-1">
                    <div>
                        <p className="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-1">{title}</p>
                        <h3 className={`text-3xl font-bold ${t.text} tracking-tight`}>{value}</h3>
                        <p className="text-xs text-slate-400 mt-2 font-medium flex items-center gap-1">{subtext}</p>
                    </div>
                    <div className={`p-4 rounded-xl ${t.iconBg} shadow-sm`}>{icon}</div>
                </div>
            );
        });

        const MiniStat = memo(({ label, value, subValue, variant = "default" }) => {
             const styles = {
                default:   { border: "border-slate-100", text: "text-actemium-primary", sub: "text-slate-500" },
                green:     { border: "border-emerald-100 bg-emerald-50/30", text: "text-emerald-700", sub: "text-emerald-600" },
                red:       { border: "border-red-100 bg-red-50/30", text: "text-red-700", sub: "text-red-600" },
            };
            const s = styles[variant] || styles.default;
            return (
                <div className={`p-4 rounded-xl border flex flex-col justify-center h-full ${s.border} bg-white shadow-soft hover:shadow-md transition-shadow`}>
                    <span className="text-[10px] uppercase font-bold tracking-wider text-slate-400 mb-1">{label}</span>
                    <span className={`text-xl font-bold leading-tight ${s.text}`}>{value}</span>
                    {subValue && <span className={`text-xs mt-1 font-medium ${s.sub}`}>{subValue}</span>}
                </div>
            );
        });

        const Th = memo(({ children, sortKey, currentSort, onSort, align = "left", className = "" }) => (
            <th className={`p-4 text-xs font-bold uppercase tracking-wider text-slate-500 bg-slate-50 border-b border-slate-200 sticky top-0 z-10 ${align === 'left' ? 'text-left' : align === 'center' ? 'text-center' : 'text-right'} ${className}`} onClick={() => onSort && onSort(sortKey)}>
                <div className={`flex items-center ${align === 'right' ? 'justify-end' : align === 'center' ? 'justify-center' : 'justify-start'}`}>
                    {children} 
                    {sortKey && <span className={`ml-1.5 inline-flex flex-col h-3 w-3 justify-center transition-opacity ${currentSort?.key === sortKey ? 'opacity-100' : 'opacity-30'}`}>
                        <Icons.ChevronUp className={`w-3 h-3 -mb-1 ${currentSort?.key === sortKey && currentSort.direction === 'asc' ? 'text-actemium-secondary' : 'text-slate-400'}`} />
                        <Icons.ChevronDown className={`w-3 h-3 ${currentSort?.key === sortKey && currentSort.direction === 'desc' ? 'text-actemium-secondary' : 'text-slate-400'}`} />
                    </span>}
                </div>
            </th>
        ));

        // --- VUES (Optimisées & Complètes) ---

        const OverviewRow = memo(({ d }) => {
            const colorClass = d.margePct < 0 ? "bg-red-500" : d.margePct >= 10 ? "bg-emerald-500" : "bg-orange-400";
            const barWidth = Math.min(Math.abs(d.margePct), 100);
            return (
                <tr className="hover:bg-slate-50 transition-colors group">
                    <td className="p-4 pl-6 font-bold text-actemium-primary">{d.devis}</td>
                    <td className="p-4 text-center"><span className="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-800">{d.responsable}</span></td>
                    <td className="p-4 text-center tabular-nums text-slate-600 group-hover:text-actemium-secondary">{formatCurrency(d.montantFacture)}</td>
                    <td className="p-4 text-center tabular-nums text-slate-500">{formatCurrency(d.prixRevient)}</td>
                    <td className={`p-4 text-center tabular-nums font-bold ${d.marge < 0 ? 'text-red-600' : 'text-emerald-600'}`}>{d.marge > 0 ? '+' : ''}{formatCurrency(d.marge)}</td>
                    <td className="p-4 text-center">
                        <div className="flex items-center justify-center gap-3">
                            <span className={`text-xs font-bold w-12 text-right ${d.margePct < 0 ? 'text-red-700' : 'text-slate-700'}`}>{d.margePct.toFixed(1)}%</span>
                            <div className="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                <div className={`h-full rounded-full ${colorClass}`} style={{width: `${barWidth}%`}}></div>
                            </div>
                        </div>
                    </td>
                </tr>
            );
        });

        const ManagerStatRow = memo(({ stat }) => (
            <tr className="hover:bg-slate-50 transition-colors group">
                <td className="p-4 font-semibold text-actemium-primary pl-6">{stat.name}</td>
                <td className="p-4 text-center tabular-nums text-slate-600 font-medium group-hover:text-actemium-secondary">{formatCurrency(stat.ca)}</td>
                <td className="p-4 text-center tabular-nums text-slate-500">{formatCurrency(stat.cout)}</td>
                <td className={`p-4 text-center tabular-nums font-bold ${stat.marge < 0 ? 'text-red-600' : 'text-emerald-600'}`}>{formatCurrency(stat.marge)}</td>
                <td className="p-4 text-center">
                    <span className={`inline-block px-2.5 py-1 rounded-md text-xs font-bold ${stat.margePct < 0 ? 'bg-red-50 text-red-700' : 'bg-emerald-50 text-emerald-700'}`}>
                        {stat.margePct.toFixed(1)}%
                    </span>
                </td>
            </tr>
        ));

        const OverviewView = ({ data, onResetFilters }) => {
            // KPIs
            const totalFacture = useMemo(() => data.reduce((acc, curr) => acc + curr.montantFacture, 0), [data]);
            const totalCout = useMemo(() => data.reduce((acc, curr) => acc + curr.prixRevient, 0), [data]);
            const margeGlobale = totalFacture - totalCout;
            const margePourcent = totalFacture > 0 ? ((margeGlobale / totalFacture) * 100).toFixed(1) : 0;
            const devisNegatif = useMemo(() => data.filter(d => (d.montantFacture - d.prixRevient) < 0).length, [data]);

            // Table Devis Data
            const tableData = useMemo(() => data.map(d => ({ ...d, marge: d.montantFacture - d.prixRevient, margePct: d.montantFacture ? ((d.montantFacture - d.prixRevient) / d.montantFacture) * 100 : 0 })), [data]);
            const { items: sortedData, requestSort, sortConfig } = useSortableData(tableData, { key: 'montantFacture', direction: 'desc' });
            const { currentData, next, prev, currentPage, maxPage } = usePagination(sortedData, 15);

            // Stats Manager
            const managerStatsRaw = useMemo(() => {
                const stats = {};
                data.forEach(d => {
                    const name = (d.responsable || 'Non défini').trim();
                    if(!stats[name]) stats[name] = { name, ca: 0, cout: 0 };
                    stats[name].ca += d.montantFacture || 0;
                    stats[name].cout += d.prixRevient || 0;
                });
                return Object.values(stats).map(v => {
                    const marge = v.ca - v.cout;
                    return { ...v, marge, margePct: v.ca ? (marge / v.ca) * 100 : 0 };
                });
            }, [data]);
            const { items: sortedManagerStats, requestSort: requestManagerSort, sortConfig: managerSort } = useSortableData(managerStatsRaw, { key: 'ca', direction: 'desc' });

            // Stats Marge
            const marginStats = useMemo(() => {
                const margins = data.map(d => ({ val: d.montantFacture - d.prixRevient, devis: d.devis }));
                if (margins.length === 0) return { avg: 0, min: {val:0, devis:'-'}, max: {val:0, devis:'-'}, median: 0 };
                
                const vals = margins.map(m => m.val).sort((a, b) => a - b);
                const sum = vals.reduce((a, b) => a + b, 0);
                const avg = sum / vals.length;
                const mid = Math.floor(vals.length / 2);
                const median = vals.length % 2 !== 0 ? vals[mid] : (vals[mid - 1] + vals[mid]) / 2;
                
                return { 
                    avg, 
                    median, 
                    min: margins.reduce((prev, curr) => prev.val < curr.val ? prev : curr), 
                    max: margins.reduce((prev, curr) => prev.val > curr.val ? prev : curr) 
                };
            }, [data]);

            if (data.length === 0) return (
                <div className="flex flex-col items-center justify-center py-16 px-4 text-center bg-white rounded-xl border border-dashed border-slate-300">
                    <Icons.Upload className="w-12 h-12 text-slate-300 mb-4" />
                    <h3 className="text-xl font-bold text-actemium-primary mb-2">Tableau de bord vide</h3>
                    <p className="text-sm text-slate-400 mb-6 max-w-sm">Veuillez importer votre fichier de suivi Excel pour visualiser les données.</p>
                    <button 
                        onClick={() => document.querySelector('input[type="file"]').click()}
                        className="flex items-center gap-2 px-6 py-3 bg-actemium-secondary text-white rounded-xl hover:bg-blue-600 transition-all shadow-lg font-bold"
                    >
                        <Icons.Upload className="w-5 h-5" /> Importer le fichier
                    </button>
                </div>
            );

            return (
                <div className="space-y-8">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <KPICard title="Montant Facturé" value={(totalFacture/1000).toLocaleString('fr-FR', {maximumFractionDigits:1}) + ' k€'} subtext={`${data.length} devis actifs`} icon={<Icons.FileText/>} type="blue" />
                        <KPICard title="Coût Revient" value={(totalCout/1000).toLocaleString('fr-FR', {maximumFractionDigits:1}) + ' k€'} subtext="Total Dépenses" icon={<Icons.PieChart/>} type="orange" />
                        <KPICard title="Marge Globale" value={`${margePourcent}%`} subtext={`Gain: ${(margeGlobale/1000).toFixed(1)} k€`} icon={<Icons.TrendingUp/>} type="green" />
                        <KPICard title="Devis à Perte" value={devisNegatif} subtext="Marge Négative" icon={<Icons.AlertCircle/>} type="red" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <Card className="lg:col-span-2 overflow-hidden p-0">
                            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white">
                                <h2 className="text-xl font-bold text-actemium-primary">Comparatif par Responsable</h2>
                            </div>
                            <div className="overflow-x-auto max-h-[450px]">
                                <table className="w-full text-sm text-left border-collapse table-fixed">
                                    <thead>
                                        <tr>
                                            <Th sortKey="name" currentSort={managerSort} onSort={requestManagerSort} align="center" className="w-1/4">Nom</Th>
                                            <Th sortKey="ca" currentSort={managerSort} onSort={requestManagerSort} align="center" className="w-1/4">Facturé</Th>
                                            <Th sortKey="cout" currentSort={managerSort} onSort={requestManagerSort} align="center" className="w-1/4">Coût</Th>
                                            <Th sortKey="marge" currentSort={managerSort} onSort={requestManagerSort} align="center" className="w-1/4">Marge</Th>
                                            <Th sortKey="margePct" currentSort={managerSort} onSort={requestManagerSort} align="center" className="w-1/4">Rentabilité</Th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {sortedManagerStats.map((stat, i) => <ManagerStatRow key={i} stat={stat} />)}
                                    </tbody>
                                </table>
                            </div>
                        </Card>

                        <div className="flex flex-col h-full">
                            <div className="grid grid-cols-2 gap-4 flex-1">
                                <MiniStat label="Marge Moyenne" value={formatCurrency(marginStats.avg)} />
                                <MiniStat label="Marge Médiane" value={formatCurrency(marginStats.median)} />
                                <MiniStat label="Meilleure Marge" value={formatCurrency(marginStats.max.val)} subValue={marginStats.max.devis} variant="green" />
                                <MiniStat label="Pire Marge" value={formatCurrency(marginStats.min.val)} subValue={marginStats.min.devis} variant="red" />
                            </div>
                        </div>
                    </div>

                    <Card className="overflow-hidden p-0">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white">
                            <h2 className="text-xl font-bold text-actemium-primary">Liste des Devis</h2>
                            <span className="bg-actemium-light text-actemium-secondary text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wide">{data.length} dossiers</span>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left border-collapse table-fixed min-w-[800px]">
                                <thead>
                                    <tr>
                                        <Th sortKey="devis" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Devis</Th>
                                        <Th sortKey="responsable" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Responsable</Th>
                                        <Th sortKey="montantFacture" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Facturé</Th>
                                        <Th sortKey="prixRevient" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Coût</Th>
                                        <Th sortKey="marge" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Marge</Th>
                                        <Th sortKey="margePct" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Rentabilité</Th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {currentData.map((d) => <OverviewRow key={d.id} d={d} />)}
                                </tbody>
                            </table>
                        </div>
                        <PaginationControls currentPage={currentPage} maxPage={maxPage} next={next} prev={prev} />
                    </Card>
                </div>
            );
        };

        const FinanceRow = memo(({ r }) => (
            <tr className="hover:bg-slate-50 transition-colors group">
                <td className="p-4 pl-6 font-semibold text-actemium-primary">{r.devis}</td>
                <td className="p-4 text-center tabular-nums font-bold text-slate-700">{formatCurrency(r.fournitureTheorique)}</td>
                <td className="p-4 text-center tabular-nums text-slate-500 bg-slate-50/50">{formatCurrency(r.fournitureEngage)}</td>
                <td className="p-4 text-center tabular-nums text-slate-500 bg-slate-50/50">{formatCurrency(r.fournitureReste)}</td>
                <td className="p-4 text-center tabular-nums font-bold text-slate-700">{formatCurrency(r.atterrissage)}</td>
                <td className={`p-4 text-center tabular-nums font-bold ${r.ecart < 0 ? 'text-red-600' : 'text-emerald-600'}`}>
                    {r.ecart > 0 ? '+' : ''}{formatCurrency(r.ecart)}
                </td>
            </tr>
        ));

        const CustomTooltip = memo(({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-white p-3 border border-slate-100 shadow-xl rounded-lg text-xs">
                        <p className="font-bold text-actemium-primary mb-2 text-sm">{label}</p>
                        {payload.map((entry, index) => (
                            <div key={index} className="flex items-center gap-2 mb-1">
                                <div className="w-2 h-2 rounded-full" style={{backgroundColor: entry.color}}></div>
                                <span className="text-slate-500">{entry.name}:</span>
                                <span className="font-medium ml-auto">{formatCurrency(entry.value)}</span>
                            </div>
                        ))}
                    </div>
                );
            }
            return null;
        });

        const FinanceView = ({ data, onResetFilters }) => {
            const activeData = useMemo(() => data.filter(r => !(r.fournitureEngage === 0 && r.fournitureReste === 0))
                .map(r => {
                    const atterrissage = r.fournitureEngage + r.fournitureReste;
                    return { ...r, atterrissage, ecart: r.fournitureTheorique - atterrissage };
                })
            , [data]);

            const { items: sortedData, requestSort, sortConfig } = useSortableData(activeData, { key: 'fournitureTheorique', direction: 'desc' });
            const { currentData, next, prev, currentPage, maxPage } = usePagination(sortedData, 15);

            // Stats graphiques
             const managerData = useMemo(() => {
                const map = {};
                activeData.forEach(d => {
                    const name = d.responsable || 'Inconnu';
                    if (!map[name]) map[name] = { name, budget: 0, engage: 0, reste: 0 };
                    map[name].budget += d.fournitureTheorique;
                    map[name].engage += d.fournitureEngage;
                    map[name].reste += d.fournitureReste;
                });
                return Object.values(map).map(item => ({ ...item, ecart: item.budget - (item.engage + item.reste) })).sort((a,b) => b.budget - a.budget);
            }, [activeData]);

            const { items: sortedManagerData, requestSort: requestManagerSort, sortConfig: managerSortConfig } = useSortableData(managerData, { key: 'budget', direction: 'desc' });

            const stats = useMemo(() => {
                const totalTheorique = activeData.reduce((acc, r) => acc + r.fournitureTheorique, 0);
                const totalEngage = activeData.reduce((acc, r) => acc + r.fournitureEngage, 0);
                const totalReste = activeData.reduce((acc, r) => acc + r.fournitureReste, 0);
                return { totalTheorique, totalEngage, totalReste, totalAtterrissage: totalEngage + totalReste, ecartGlobal: totalTheorique - (totalEngage + totalReste) };
            }, [activeData]);

            if (activeData.length === 0) return <div className="p-12 text-center text-slate-500">Aucune donnée financière.</div>;

            return (
                <div className="space-y-8">
                     <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <KPICard title="Budget Fournitures" value={formatCurrency(stats.totalTheorique)} subtext="Théorique" icon={<Icons.Package/>} type="blue" />
                        <KPICard title="Déjà Engagé" value={formatCurrency(stats.totalEngage)} subtext={`Reste: ${formatCurrency(stats.totalReste)}`} icon={<Icons.ShoppingCart/>} type="orange" />
                        <KPICard title="Atterrissage Prévu" value={formatCurrency(stats.totalAtterrissage)} subtext="Engagé + Reste" icon={<Icons.Target/>} type="blue" />
                        <KPICard title="Écart Global" value={(stats.ecartGlobal > 0 ? "+" : "") + formatCurrency(stats.ecartGlobal)} subtext={stats.ecartGlobal >= 0 ? "Économie" : "Dépassement"} icon={stats.ecartGlobal >= 0 ? <Icons.Check/> : <Icons.AlertCircle/>} type={stats.ecartGlobal >= 0 ? "green" : "red"} />
                    </div>

                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                        <Card className="p-6">
                            <h3 className="text-xl font-bold text-actemium-primary mb-2">Analyse Budgétaire</h3>
                            <div className="h-80 w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={managerData} margin={{ top: 0, right: 30, left: 0, bottom: 5 }} barSize={20}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={COLORS.grid} />
                                        <XAxis dataKey="name" tick={{fontSize: 11, fill:'#64748b'}} axisLine={false} tickLine={false} dy={10} />
                                        <YAxis tickFormatter={(val) => `${(val/1000).toFixed(0)}k`} tick={{fontSize: 11, fill:'#64748b'}} axisLine={false} tickLine={false} />
                                        <Tooltip cursor={{fill: '#f8fafc', opacity: 0.5}} content={<CustomTooltip />} />
                                        <Legend verticalAlign="top" height={30} iconType="circle" iconSize={8} />
                                        <Bar dataKey="budget" name="Budget" fill={COLORS.secondary} radius={[2, 2, 0, 0]} />
                                        <Bar dataKey="engage" stackId="a" name="Engagé" fill={COLORS.orange} />
                                        <Bar dataKey="reste" stackId="a" name="Reste" fill={COLORS.accent} radius={[2, 2, 0, 0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </Card>

                        <Card className="p-0 flex flex-col h-[420px] overflow-hidden">
                            <div className="p-6 border-b border-slate-100 bg-white">
                                <h2 className="text-xl font-bold text-actemium-primary">Détail Responsable</h2>
                            </div>
                            <div className="flex-1 overflow-auto">
                                <table className="w-full text-sm text-left border-collapse table-fixed">
                                    <thead>
                                        <tr>
                                            <Th sortKey="name" currentSort={managerSortConfig} onSort={requestManagerSort} align="center">Nom</Th>
                                            <Th sortKey="budget" currentSort={managerSortConfig} onSort={requestManagerSort} align="center">Budget</Th>
                                            <Th sortKey="engage" currentSort={managerSortConfig} onSort={requestManagerSort} align="center">Engagé</Th>
                                            <Th sortKey="reste" currentSort={managerSortConfig} onSort={requestManagerSort} align="center">Reste</Th>
                                            <Th sortKey="ecart" currentSort={managerSortConfig} onSort={requestManagerSort} align="center">Ecart</Th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {sortedManagerData.map((m) => (
                                            <tr key={m.name} className="hover:bg-slate-50 transition-colors group">
                                                <td className="p-4 pl-6 font-semibold text-actemium-primary truncate" title={m.name}>{m.name}</td>
                                                <td className="p-4 text-center text-slate-600 font-medium tabular-nums group-hover:text-actemium-secondary">{formatCurrency(m.budget, 0)}</td>
                                                <td className="p-4 text-center text-slate-600 font-medium tabular-nums group-hover:text-actemium-secondary">{formatCurrency(m.engage, 0)}</td>
                                                <td className="p-4 text-center text-slate-500 tabular-nums">{formatCurrency(m.reste, 0)}</td>
                                                <td className={`p-4 text-center font-bold tabular-nums ${m.ecart < 0 ? 'text-red-600' : 'text-emerald-600'}`}>{formatCurrency(m.ecart, 0)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    </div>

                    <Card className="p-0 overflow-hidden">
                        <div className="p-6 border-b border-slate-100 bg-white">
                             <h2 className="text-xl font-bold text-actemium-primary">Vue Détaillée des Affaires</h2>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm table-fixed min-w-[800px]">
                                <thead>
                                    <tr>
                                        <Th sortKey="devis" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Devis</Th>
                                        <Th sortKey="fournitureTheorique" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Théorique</Th>
                                        <Th sortKey="fournitureEngage" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Engagé</Th>
                                        <Th sortKey="fournitureReste" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Reste</Th>
                                        <Th sortKey="atterrissage" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Atterrissage</Th>
                                        <Th sortKey="ecart" currentSort={sortConfig} onSort={requestSort} align="center" className="w-1/6">Ecart</Th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {currentData.map(r => <FinanceRow key={r.id} r={r} />)}
                                </tbody>
                            </table>
                        </div>
                         <PaginationControls currentPage={currentPage} maxPage={maxPage} next={next} prev={prev} />
                    </Card>
                </div>
            );
        };

        const OperationsHeatmap = memo(({ data, onRowClick }) => {
            const sections = ['01','02','03','04','05','07','08'];
            
            // Modification : Ajout du paramètre 'remaining' pour calculer le dépassement à l'atterrissage
            const getStatusColor = (planned, done, remaining = 0) => {
                if (!planned || planned === 0) return 'bg-slate-100 border border-slate-200';
                
                // SI (Réalisé + Reste à Faire) > Prévu => Orange (Dépassement projeté)
                if ((done + remaining) > planned) return 'bg-actemium-orange text-white shadow-sm ring-2 ring-orange-100';
                
                if (done >= planned) return 'bg-actemium-accent text-actemium-primary shadow-sm';
                if (done > 0) return 'bg-actemium-secondary text-white shadow-sm';
                return 'bg-blue-100 text-blue-300';
            };

            const counts = useMemo(() => {
                let inProgress = 0, done = 0, over = 0;
                data.forEach(d => {
                    sections.forEach(s => {
                        const sec = d.sections[s];
                        if (sec) {
                             // Modification : Compte comme 'Dépassement' si l'atterrissage dépasse le prévu
                             if ((sec.done + sec.remaining) > sec.planned && sec.planned > 0) over++;
                             else if (sec.done >= sec.planned && sec.planned > 0) done++;
                             else if (sec.done > 0) inProgress++;
                        }
                    });
                });
                return { inProgress, done, over };
            }, [data]);

            return (
                <Card className="mb-8 border-none shadow-soft p-0 overflow-hidden">
                    <div className="p-6 border-b border-slate-100 flex justify-between items-end bg-white">
                        <div>
                            <h3 className="text-xl font-bold text-actemium-primary flex items-center gap-2">
                                <Icons.LayoutDashboard className="text-actemium-accent"/> Heatmap Opérationnelle
                            </h3>
                            <p className="text-sm text-slate-400 mt-1">Avancement des heures par section ({data.length} dossiers affichés)</p>
                        </div>
                        <div className="flex gap-4 text-xs font-medium">
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-actemium-secondary"></div> En cours <span className="text-slate-400">({counts.inProgress})</span></div>
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-actemium-accent"></div> Terminé <span className="text-slate-400">({counts.done})</span></div>
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-actemium-orange"></div> Dépassement <span className="text-slate-400">({counts.over})</span></div>
                        </div>
                    </div>
                    <div className="overflow-x-auto p-6">
                        <table className="w-full text-xs border-separate border-spacing-y-2">
                            <thead>
                                <tr>
                                    <th className="text-left text-slate-400 uppercase font-bold tracking-wider w-56 pb-2 pl-2">Devis</th>
                                    {sections.map(s => <th key={s} className="text-center text-slate-400 uppercase font-bold tracking-wider pb-2">S{s}</th>)}
                                </tr>
                            </thead>
                            <tbody>
                                {data.map(d => (
                                    <tr key={d.id} id={`heatmap-row-${d.id}`} className="group hover:bg-slate-50/80 transition-colors rounded-lg">
                                        <td 
                                            className="font-bold text-actemium-primary py-2 pr-4 pl-2 text-sm cursor-pointer hover:text-actemium-secondary hover:underline flex items-center gap-2"
                                            onClick={() => onRowClick(d.id)}
                                            title="Voir le détail en bas"
                                        >
                                            {d.devis}
                                        </td>
                                        {sections.map(s => {
                                            const sec = d.sections[s];
                                            return (
                                                <td key={s} className="p-1">
                                                    <div 
                                                        className={`mx-auto w-10 h-10 rounded-full flex items-center justify-center font-bold transition-transform hover:scale-110 cursor-default ${getStatusColor(sec?.planned, sec?.done, sec?.remaining)}`} 
                                                        title={`Prévu: ${sec.planned}h\nRéalisé: ${sec.done}h\nReste à faire: ${sec.remaining}h\nAtterrissage: ${sec.done + sec.remaining}h`}
                                                    >
                                                        {sec.planned > 0 ? (sec.done >= sec.planned && sec.done - sec.planned < 1 ? <Icons.Check className="w-5 h-5"/> : <span>{Math.round((sec.done/sec.planned)*100)}%</span>) : ''}
                                                    </div>
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        });

        const OperationsView = ({ data }) => {
            const sections = ['01','02','03','04','05','07','08'];
            const activeProjects = useMemo(() => data.filter(d => sections.some(s => d.sections[s]?.planned > 0)), [data]);
            
            // Pagination configurée à 25 éléments pour synchroniser Heatmap et Cartes
            const { currentData, next, prev, currentPage, maxPage } = usePagination(activeProjects, 25);

            // Gestion du scroll
            const scrollToCard = (id) => {
                const el = document.getElementById(`card-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Petit effet visuel pour repérer la carte
                    el.classList.add('ring-2', 'ring-actemium-accent');
                    setTimeout(() => el.classList.remove('ring-2', 'ring-actemium-accent'), 2000);
                }
            };

            const scrollToRow = (id) => {
                const el = document.getElementById(`heatmap-row-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('bg-blue-50');
                    setTimeout(() => el.classList.remove('bg-blue-50'), 2000);
                }
            };

            // --- Calcul des Stats par Section pour le graphique ---
            const sectionsChartData = useMemo(() => {
                return sections.map(s => {
                    let planned = 0, done = 0, remaining = 0;
                    activeProjects.forEach(d => {
                        const sec = d.sections[s];
                        if (sec) {
                            planned += sec.planned || 0;
                            done += sec.done || 0;
                            remaining += sec.remaining || 0;
                        }
                    });
                    return { 
                        name: `S${s}`, 
                        fullLabel: `Section ${s}`,
                        planned: Math.round(planned), 
                        done: Math.round(done), 
                        remaining: Math.round(remaining) 
                    };
                });
            }, [activeProjects]);

            // --- Calcul des KPIs Opérationnels ---
            const opsStats = useMemo(() => {
                let totalPlanned = 0;
                let totalDone = 0;
                let totalRemaining = 0;
                let sectionsOverBudget = 0;

                activeProjects.forEach(p => {
                    let pPlanned = 0;
                    let pDone = 0;
                    let pRemaining = 0;

                    sections.forEach(s => {
                        const sec = p.sections[s];
                        if (sec) {
                            pPlanned += sec.planned || 0;
                            pDone += sec.done || 0;
                            pRemaining += sec.remaining || 0;

                            // ALIGNEMENT LOGIQUE : On compte les SECTIONS en alerte pour correspondre à la Heatmap
                            // Condition identique : Atterrissage (Fait + Reste) > Prévu
                            if ((sec.done + sec.remaining) > sec.planned && sec.planned > 0) {
                                sectionsOverBudget++;
                            }
                        }
                    });

                    totalPlanned += pPlanned;
                    totalDone += pDone;
                    totalRemaining += pRemaining;
                });

                const globalProgress = totalPlanned > 0 ? (totalDone / totalPlanned) * 100 : 0;

                return { totalPlanned, totalDone, totalRemaining, sectionsOverBudget, globalProgress };
            }, [activeProjects]);

            if (activeProjects.length === 0) return <div className="p-12 text-center text-slate-500">Aucun projet actif.</div>;

            return (
                <div className="space-y-6">
                    {/* --- KPIs --- */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <KPICard title="Heures Prévues" value={opsStats.totalPlanned.toLocaleString('fr-FR')} subtext="Volume total engagé" icon={<Icons.Clock/>} type="blue" />
                        <KPICard title="Avancement Global" value={`${opsStats.globalProgress.toFixed(1)}%`} subtext={`Réalisé: ${opsStats.totalDone.toLocaleString('fr-FR')} h`} icon={<Icons.BarChart2/>} type="orange" />
                        <KPICard title="Reste à Faire" value={opsStats.totalRemaining.toLocaleString('fr-FR')} subtext="Heures à produire" icon={<Icons.Hourglass/>} type="blue" />
                        <KPICard title="Sections en Dépassement" value={opsStats.sectionsOverBudget} subtext="Alertes Opérationnelles" icon={<Icons.AlertTriangle/>} type="red" />
                    </div>

                    {/* --- Graphique Global par Section (NOUVEAU) --- */}
                    <Card className="p-6">
                        <div className="mb-6 flex justify-between items-center">
                            <div>
                                <h3 className="text-xl font-bold text-actemium-primary flex items-center gap-2">
                                    <Icons.BarChart2 className="text-actemium-secondary"/> Charge par Section
                                </h3>
                                <p className="text-sm text-slate-400 mt-1">Comparatif : Prévu vs Réalisé vs Reste à Faire</p>
                            </div>
                        </div>
                        <div className="h-80 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={sectionsChartData} margin={{ top: 20, right: 30, left: 10, bottom: 5 }} barGap={2}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={COLORS.grid} />
                                    <XAxis dataKey="name" tick={{fontSize: 12, fill:'#64748b'}} axisLine={false} tickLine={false} dy={10} />
                                    <YAxis tick={{fontSize: 12, fill:'#64748b'}} axisLine={false} tickLine={false} tickFormatter={(v) => v.toLocaleString()} />
                                    <Tooltip 
                                        cursor={{fill: '#f8fafc', opacity: 0.5}} 
                                        content={({ active, payload, label }) => {
                                            if (active && payload && payload.length) {
                                                // Retrouver le nom complet pour le tooltip
                                                const item = sectionsChartData.find(s => s.name === label);
                                                return (
                                                    <div className="bg-white p-3 border border-slate-100 shadow-xl rounded-lg text-xs">
                                                        <p className="font-bold text-actemium-primary mb-2 text-sm">{item ? item.fullLabel : label}</p>
                                                        {payload.map((entry, index) => (
                                                            <div key={index} className="flex items-center gap-2 mb-1">
                                                                <div className="w-2 h-2 rounded-full" style={{backgroundColor: entry.fill}}></div>
                                                                <span className="text-slate-500">{entry.name}:</span>
                                                                <span className="font-medium ml-auto">{entry.value.toLocaleString()} h</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                );
                                            }
                                            return null;
                                        }}
                                    />
                                    <Legend verticalAlign="top" height={36} iconType="circle" />
                                    <Bar dataKey="planned" name="Prévu" fill={COLORS.secondary} radius={[2, 2, 0, 0]} />
                                    {/* Modification ici : Ajout de stackId="a" pour empiler Réalisé et Reste à faire */}
                                    <Bar dataKey="done" stackId="a" name="Réalisé" fill={COLORS.accent} />
                                    <Bar dataKey="remaining" stackId="a" name="Reste à Faire" fill={COLORS.orange} radius={[2, 2, 0, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </Card>

                    {/* --- Heatmap Synchronisée --- */}
                    <OperationsHeatmap data={currentData} onRowClick={scrollToCard} />
                    
                    {/* --- Pagination commune --- */}
                    <Card className="p-4 bg-white border-slate-200 shadow-soft flex justify-between items-center">
                         <span className="text-actemium-primary font-bold text-sm">Affichage : {currentPage} / {maxPage} (25 par page)</span>
                         <div className="flex gap-2">
                            <button onClick={prev} disabled={currentPage === 1} className="p-2 hover:bg-slate-100 rounded border border-slate-200 disabled:opacity-50 transition-colors"><Icons.ChevronLeft className="w-4 h-4 text-slate-600"/></button>
                            <button onClick={next} disabled={currentPage === maxPage} className="p-2 hover:bg-slate-100 rounded border border-slate-200 disabled:opacity-50 transition-colors"><Icons.ChevronRight className="w-4 h-4 text-slate-600"/></button>
                         </div>
                    </Card>

                    {/* --- Liste Cartes Synchronisée --- */}
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                        {currentData.map(p => (
                            <div key={p.id} id={`card-${p.id}`} className="bg-white p-6 rounded-xl border border-slate-100 shadow-soft transition-all duration-500">
                                <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                                    <div 
                                        className="flex items-center gap-2 cursor-pointer group"
                                        onClick={() => scrollToRow(p.id)}
                                        title="Voir dans la heatmap"
                                    >
                                        <h3 className="text-lg font-bold text-actemium-primary group-hover:text-actemium-secondary transition-colors">{p.devis}</h3>
                                        <Icons.ChevronUp className="w-4 h-4 text-slate-300 opacity-0 group-hover:opacity-100 -translate-y-1 transition-all" />
                                    </div>
                                    <span className="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded-full font-medium">{p.responsable}</span>
                                </div>
                                <div className="grid grid-cols-2 gap-x-8 gap-y-6">
                                    {sections.map(s => {
                                        const sec = p.sections[s];
                                        if(!sec || sec.planned <= 0) return null;
                                        
                                        const donePct = Math.min((sec.done / sec.planned) * 100, 100);
                                        const remPct = Math.min((sec.remaining / sec.planned) * 100, 100 - donePct);
                                        
                                        const isRealizedOver = sec.done > sec.planned;
                                        const isProjectedOver = (sec.done + sec.remaining) > sec.planned;
                                        
                                        // CORRECTION : Si Réalisé >= Prévu ET qu'il reste du travail (RAF > 0), c'est une alerte ORANGE
                                        const isDoneBarOrange = isRealizedOver || (sec.done >= sec.planned && sec.remaining > 0);

                                        return (
                                            <div key={s} className="col-span-1">
                                                <div className="flex justify-between text-xs mb-2 font-medium">
                                                    <span className="text-slate-500 uppercase tracking-wide">Section {s}</span>
                                                    <div className="text-right">
                                                        <span className={isDoneBarOrange ? "text-actemium-orange font-bold" : "text-slate-700"}>{sec.done} / {sec.planned} h</span>
                                                        {sec.remaining > 0 && <span className="text-[10px] text-slate-400 block font-normal">RAF: {sec.remaining} h</span>}
                                                    </div>
                                                </div>
                                                <div className="w-full bg-slate-100 rounded-full h-2.5 flex overflow-hidden">
                                                    <div className={`h-full ${isDoneBarOrange ? 'bg-actemium-orange' : 'bg-actemium-secondary'}`} style={{width: `${donePct}%`}}></div>
                                                    {!isRealizedOver && sec.remaining > 0 && (
                                                        <div className={`h-full ${isProjectedOver ? 'bg-orange-300' : 'bg-blue-200'}`} style={{width: `${remPct}%`}}></div>
                                                    )}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SingleSelect = memo(({ label, options, value, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const wrapperRef = useRef(null);
            
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setIsOpen(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            useEffect(() => { if (!isOpen) setSearchTerm(""); }, [isOpen]);

            const filteredOptions = options.filter(opt => 
                opt.toString().toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="relative" ref={wrapperRef}>
                    <label className="text-[10px] font-bold text-blue-200 uppercase mb-1.5 block tracking-wider opacity-80">{label}</label>
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full bg-blue-900/40 border border-blue-400/30 rounded-lg p-2.5 text-sm text-white text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-actemium-accent/50 hover:bg-blue-900/60 transition-colors">
                        <span className="truncate pr-2 font-medium">{value}</span>
                        <Icons.ChevronDown className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''} text-actemium-accent`} />
                    </button>
                    {isOpen && (
                        <div className="absolute z-50 w-full mt-2 bg-white rounded-lg shadow-xl max-h-60 overflow-hidden border border-slate-100 flex flex-col">
                            <div className="p-2 border-b border-slate-50 bg-slate-50/50">
                                <div className="relative">
                                    <Icons.Search className="w-3.5 h-3.5 text-slate-400 absolute left-2.5 top-1/2 -translate-y-1/2" />
                                    <input 
                                        type="text" 
                                        placeholder="Rechercher..." 
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full pl-8 pr-3 py-1.5 text-xs border border-slate-200 rounded-md focus:outline-none focus:border-actemium-secondary focus:ring-1 focus:ring-actemium-secondary/20 text-slate-800"
                                        autoFocus
                                    />
                                </div>
                            </div>
                            <div className="overflow-y-auto flex-1">
                                <div 
                                    className={`px-3 py-2 hover:bg-slate-50 cursor-pointer text-xs font-bold border-b border-slate-50 uppercase tracking-wider ${value === 'Tous' ? 'text-actemium-primary bg-slate-50' : 'text-slate-500'}`} 
                                    onClick={() => { onChange('Tous'); setIsOpen(false); }}
                                >
                                    Tous
                                </div>
                                {filteredOptions.length > 0 ? filteredOptions.map(opt => (
                                    <div key={opt} className="px-3 py-2.5 hover:bg-slate-50 cursor-pointer flex items-center gap-3" onClick={() => { onChange(opt); setIsOpen(false); }}>
                                        <div className={`w-5 h-5 border rounded-full flex-shrink-0 flex items-center justify-center ${value == opt ? 'bg-actemium-secondary border-actemium-secondary' : 'border-slate-300 bg-white'}`}>
                                            {value == opt && <div className="w-2.5 h-2.5 rounded-full bg-white" />}
                                        </div>
                                        <span className={`text-sm truncate ${value == opt ? 'text-actemium-primary font-semibold' : 'text-slate-600'}`}>{opt}</span>
                                    </div>
                                )) : (
                                    <div className="px-3 py-4 text-center text-xs text-slate-400 italic">Aucun résultat</div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        const MultiSelect = memo(({ label, options, selected, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            const wrapperRef = useRef(null);
            
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setIsOpen(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            useEffect(() => {
                if (!isOpen) setSearchTerm("");
            }, [isOpen]);

            const toggleOption = (val) => {
                const newSelected = selected.includes(val) ? selected.filter(s => s !== val) : [...selected, val];
                onChange(newSelected);
            };

            const filteredOptions = options.filter(opt => 
                opt.toString().toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="relative" ref={wrapperRef}>
                    <label className="text-[10px] font-bold text-blue-200 uppercase mb-1.5 block tracking-wider opacity-80">{label}</label>
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full bg-blue-900/40 border border-blue-400/30 rounded-lg p-2.5 text-sm text-white text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-actemium-accent/50 hover:bg-blue-900/60 transition-colors">
                        <span className="truncate pr-2 font-medium">{selected.length === 0 ? "Tous" : selected.length === 1 ? selected[0] : `${selected.length} sélectionnés`}</span>
                        <Icons.ChevronDown className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''} text-actemium-accent`} />
                    </button>
                    {isOpen && (
                        <div className="absolute z-50 w-full mt-2 bg-white rounded-lg shadow-xl max-h-60 overflow-hidden border border-slate-100 flex flex-col">
                            <div className="p-2 border-b border-slate-50 bg-slate-50/50">
                                <div className="relative">
                                    <Icons.Search className="w-3.5 h-3.5 text-slate-400 absolute left-2.5 top-1/2 -translate-y-1/2" />
                                    <input 
                                        type="text" 
                                        placeholder="Rechercher..." 
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full pl-8 pr-3 py-1.5 text-xs border border-slate-200 rounded-md focus:outline-none focus:border-actemium-secondary focus:ring-1 focus:ring-actemium-secondary/20 text-slate-800"
                                        autoFocus
                                    />
                                </div>
                            </div>
                            <div className="overflow-y-auto flex-1">
                                <div className="px-3 py-2 hover:bg-slate-50 cursor-pointer text-slate-500 text-xs font-bold border-b border-slate-50 uppercase tracking-wider" onClick={() => { onChange([]); setIsOpen(false); }}>Tout effacer</div>
                                {filteredOptions.length > 0 ? filteredOptions.map(opt => (
                                    <div key={opt} className="px-3 py-2.5 hover:bg-slate-50 cursor-pointer flex items-center gap-3" onClick={() => toggleOption(opt)}>
                                        <div className={`w-5 h-5 border rounded flex-shrink-0 flex items-center justify-center ${selected.includes(opt) ? 'bg-actemium-secondary border-actemium-secondary' : 'border-slate-300 bg-white'}`}>
                                            {selected.includes(opt) && <Icons.Check className="text-white w-3.5 h-3.5" />}
                                        </div>
                                        <span className={`text-sm truncate ${selected.includes(opt) ? 'text-actemium-primary font-semibold' : 'text-slate-600'}`}>{opt}</span>
                                    </div>
                                )) : (
                                    <div className="px-3 py-4 text-center text-xs text-slate-400 italic">Aucun résultat</div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, [onClose]);
            const isError = type === 'error';
            return (
                <div className={`fixed bottom-4 right-4 z-50 flex items-center gap-3 px-6 py-4 rounded-xl shadow-2xl toast-enter font-medium border ${isError ? 'bg-red-50 border-red-200 text-red-700' : 'bg-white border-actemium-accent text-actemium-primary'}`}>
                    <div className={`p-2 rounded-full ${isError ? 'bg-red-100' : 'bg-actemium-accent'}`}>
                        {isError ? <Icons.AlertCircle className="w-5 h-5"/> : <Icons.Check className="w-5 h-5 text-actemium-primary"/>}
                    </div>
                    <span>{message}</span>
                    <button onClick={onClose} className="ml-2 hover:opacity-50"><Icons.X className="w-4 h-4"/></button>
                </div>
            );
        };

        const Dashboard = () => {
            const [data, setData] = useState([]);
            const [view, setView] = useState('overview');
            const [yearFilter, setYearFilter] = useState('Tous');
            const [respFilter, setRespFilter] = useState([]);
            const [devisFilter, setDevisFilter] = useState([]);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [toast, setToast] = useState({ message: '', type: '', visible: false });
            const [isFiltering, startTransition] = useTransition();
            const fileRef = useRef(null);

            // Effacement des données locales au démarrage
            useEffect(() => {
                localStorage.removeItem('actemiumDashboardData');
            }, []);

            const uniqueYears = useMemo(() => [...new Set(data.map(d => d.annee))].sort(), [data]);
            const uniqueResp = useMemo(() => [...new Set(data.map(d => d.responsable))].sort(), [data]);
            const uniqueDevis = useMemo(() => [...new Set(data.map(d => d.devis))].sort(), [data]);

            const filteredData = useMemo(() => {
                return data.filter(d => {
                    const matchYear = yearFilter === 'Tous' || d.annee == yearFilter;
                    const matchResp = respFilter.length === 0 || respFilter.includes(d.responsable);
                    const matchDevis = devisFilter.length === 0 || devisFilter.includes(d.devis);
                    return matchYear && matchResp && matchDevis;
                });
            }, [data, yearFilter, respFilter, devisFilter]);

            const handleFilterChange = (setter, value) => {
                startTransition(() => {
                    setter(value);
                });
            };

            const handleFileUpload = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        if (json.length) { 
                            processData(json); 
                            setToast({message: `${json.length} lignes actualisées !`, type: 'success', visible: true}); 
                        } 
                    } catch (err) { setToast({message: "Erreur lecture Excel.", type: 'error', visible: true}); }
                    // Important : Réinitialiser l'input pour permettre de re-sélectionner le même fichier si besoin
                    e.target.value = '';
                };
                r.readAsBinaryString(f);
            };

            const processData = (raw) => {
                const cleanNum = (v) => parseFloat(String(v || 0).replace(/\s/g, '').replace(',', '.')) || 0;
                const normalize = (str) => str ? str.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "") : "";
                const findValue = (row, targetName) => {
                    const targetNorm = normalize(targetName);
                    const key = Object.keys(row).find(k => normalize(k) === targetNorm);
                    return key ? row[key] : undefined;
                };

                const processed = raw.map((item, i) => {
                    const sections = {};
                    ['01','02','03','04','05','07','08'].forEach(s => {
                        sections[s] = { 
                            planned: cleanNum(findValue(item, `Heures prévues section ${s}`)), 
                            done: cleanNum(findValue(item, `Heures réalisées section ${s}`)), 
                            remaining: cleanNum(findValue(item, `Heures reste à faire section ${s}`)) 
                        };
                    });
                    return {
                        id: i,
                        devis: findValue(item, 'N° Devis') || findValue(item, 'Devis') || `Ligne ${i}`,
                        annee: findValue(item, 'Année') ? String(findValue(item, 'Année')) : 'Inconnu',
                        responsable: findValue(item, 'Responsable') || 'Inconnu',
                        montantFacture: cleanNum(findValue(item, 'Montant facturé')),
                        prixRevient: cleanNum(findValue(item, 'Prix de revient')),
                        fournitureTheorique: cleanNum(findValue(item, 'Montant théorique fourniture')),
                        fournitureEngage: cleanNum(findValue(item, 'Montant déjà engagé fourniture')),
                        fournitureReste: cleanNum(findValue(item, 'Montant reste à dépenser fourniture')),
                        avancement: cleanNum(findValue(item, "Taux d'avancement"))*100,
                        sections
                    };
                });
                setData(processed);
                // Pas de sauvegarde localStorage
            };

            const resetFilters = () => {
                setYearFilter('Tous');
                setRespFilter([]);
                setDevisFilter([]);
            };

            const ActiveFilters = () => {
                if (yearFilter === 'Tous' && respFilter.length === 0 && devisFilter.length === 0) return null;
                return (
                    <div className="flex flex-wrap items-center gap-2 mb-6 animate-fade-in">
                        <span className="text-xs font-bold text-slate-400 uppercase tracking-wide mr-2">Filtres actifs :</span>
                        {yearFilter !== 'Tous' && (
                            <span className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-100 text-actemium-primary text-xs font-bold border border-blue-200">
                                Année: {yearFilter} <button onClick={() => setYearFilter('Tous')} className="hover:text-red-500"><Icons.X className="w-3 h-3"/></button>
                            </span>
                        )}
                        {respFilter.map(r => (
                            <span key={r} className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-100 text-actemium-primary text-xs font-bold border border-blue-200">
                                Resp: {r} <button onClick={() => setRespFilter(respFilter.filter(x => x !== r))} className="hover:text-red-500"><Icons.X className="w-3 h-3"/></button>
                            </span>
                        ))}
                        {devisFilter.map(d => (
                            <span key={d} className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-100 text-actemium-primary text-xs font-bold border border-blue-200">
                                {d} <button onClick={() => setDevisFilter(devisFilter.filter(x => x !== d))} className="hover:text-red-500"><Icons.X className="w-3 h-3"/></button>
                            </span>
                        ))}
                        <button onClick={resetFilters} className="text-xs text-red-500 hover:text-red-700 underline ml-2">Tout effacer</button>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex relative font-sans bg-[#f8fafc]">
                    {toast.visible && <Toast message={toast.message} type={toast.type} onClose={() => setToast({...toast, visible:false})} />}
                    
                    {mobileMenuOpen && <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-30 md:hidden" onClick={() => setMobileMenuOpen(false)} />}

                    <aside className={`fixed inset-y-0 left-0 z-40 w-72 bg-actemium-primary text-white flex flex-col shadow-2xl transform transition-transform duration-300 md:translate-x-0 md:static md:flex ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-8 border-b border-blue-800/50 flex justify-between items-center bg-blue-900/20">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-3 tracking-tight"><Icons.Factory className="text-actemium-accent w-6 h-6"/> Actemium</h1>
                                <p className="text-[10px] text-blue-200 mt-1 uppercase tracking-[0.2em] font-semibold">Gestion Affaires</p>
                            </div>
                            <button onClick={() => setMobileMenuOpen(false)} className="md:hidden text-white hover:text-actemium-accent"><Icons.X /></button>
                        </div>
                        
                        <div className="p-6">
                            <nav className="space-y-2">
                                {[
                                    { id: 'overview', label: "Vue d'ensemble", icon: <Icons.LayoutDashboard/> },
                                    { id: 'finance', label: "Suivi Financier", icon: <Icons.Wallet/> },
                                    { id: 'operations', label: "Suivi Opérationnel", icon: <Icons.Activity/> },
                                ].map(item => (
                                    <button key={item.id} onClick={() => { setView(item.id); setMobileMenuOpen(false); }} 
                                        className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-sm font-bold transition-all duration-200 ${view === item.id ? 'bg-actemium-accent text-actemium-primary shadow-lg scale-105' : 'text-blue-100 hover:bg-white/10'}`}>
                                        {item.icon} {item.label}
                                    </button>
                                ))}
                            </nav>
                        </div>

                        <div className="px-6 flex-1 overflow-y-auto">
                            <div className="pt-6 border-t border-blue-800/50">
                                <h3 className="text-xs font-bold text-blue-300 uppercase mb-4 flex items-center gap-2 tracking-wider"><Icons.Filter className="w-4 h-4" /> Filtres</h3>
                                <div className="space-y-5">
                                    <div className={isFiltering ? 'opacity-50 pointer-events-none' : ''}>
                                        <SingleSelect label="Année" options={uniqueYears} value={yearFilter} onChange={val => handleFilterChange(setYearFilter, val)} />
                                    </div>
                                    <div className={isFiltering ? 'opacity-50 pointer-events-none' : ''}>
                                        <MultiSelect label="Responsables" options={uniqueResp} selected={respFilter} onChange={val => handleFilterChange(setRespFilter, val)} />
                                    </div>
                                    <div className={isFiltering ? 'opacity-50 pointer-events-none' : ''}>
                                        <MultiSelect label="Devis" options={uniqueDevis} selected={devisFilter} onChange={val => handleFilterChange(setDevisFilter, val)} />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="p-6 border-t border-blue-800/50 bg-blue-900/20">
                            <input type="file" ref={fileRef} className="hidden" accept=".csv,.xlsx,.xls" onChange={handleFileUpload} />
                            
                            {data.length > 0 && (
                                <button 
                                    onClick={() => fileRef.current.click()} 
                                    className="w-full bg-actemium-accent text-actemium-primary hover:bg-yellow-400 py-3 mb-3 rounded-xl flex items-center justify-center gap-3 font-bold transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5"
                                >
                                    <Icons.RefreshCw className="w-5 h-5"/> Actualiser les données
                                </button>
                            )}

                            <button onClick={() => fileRef.current.click()} className={`w-full flex items-center justify-center gap-3 font-bold transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 border border-blue-400/20 py-3 rounded-xl ${data.length > 0 ? 'bg-blue-800/40 text-blue-200 hover:bg-blue-800 hover:text-white text-sm' : 'bg-actemium-secondary hover:bg-blue-600 text-white'}`}>
                                <Icons.Upload className="w-5 h-5"/> {data.length > 0 ? 'Importer un autre fichier' : 'Importer Excel'}
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="bg-white border-b border-slate-200 py-4 px-8 flex items-center justify-between shrink-0 z-20">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setMobileMenuOpen(true)} className="md:hidden text-actemium-primary p-2 hover:bg-slate-100 rounded-lg"><Icons.Menu /></button>
                                <div>
                                    <h2 className="text-2xl font-bold text-actemium-primary tracking-tight">
                                        {view === 'overview' ? "Vue d'ensemble" : view === 'finance' ? "Suivi Financier" : "Suivi Opérationnel"}
                                    </h2>
                                    <p className="text-xs text-slate-400 mt-0.5 font-medium">Tableau de bord de gestion</p>
                                </div>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-6 md:p-8 custom-scrollbar">
                            <div className="max-w-7xl mx-auto pb-12">
                                <ActiveFilters />
                                {view === 'overview' && <OverviewView data={filteredData} onResetFilters={resetFilters} />}
                                {view === 'finance' && <FinanceView data={filteredData} onResetFilters={resetFilters} />}
                                {view === 'operations' && <OperationsView data={filteredData} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
